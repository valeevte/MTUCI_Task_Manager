package bot

import (
	"sync"
	"time"
)

// ============================================================
// –°—Ç–∞—Ç—É—Å—ã –∑–∞–¥–∞—á
// –ú–æ–∂–µ—à—å –∏–∑–º–µ–Ω–∏—Ç—å —ç–º–æ–¥–∑–∏ –∏ —Ç–µ–∫—Å—Ç –Ω–∞ —Å–≤–æ–π –≤–∫—É—Å
// ============================================================
const (
	StatusNew        = "üÜï –ù–æ–≤–∞—è"
	StatusInProgress = "üîÑ –í —Ä–∞–±–æ—Ç–µ"
	StatusDone       = "‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–∞"
)

// ============================================================
// Task ‚Äî –º–æ–¥–µ–ª—å –∑–∞–¥–∞—á–∏
// –ü–æ–∑–∂–µ —Å—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–µ –ø–æ–ª—è:
// - Deadline time.Time   // –î–µ–¥–ª–∞–π–Ω
// - Priority int         // –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç (1-5)
// - Assignee string      // –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å
// ============================================================
type Task struct {
	ID          int       `json:"id"`          // –£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞–¥–∞—á–∏
	Title       string    `json:"title"`       // –ù–∞–∑–≤–∞–Ω–∏–µ
	Description string    `json:"description"` // –û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
	Status      string    `json:"status"`      // –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–æ–¥–Ω–∞ –∏–∑ –∫–æ–Ω—Å—Ç–∞–Ω—Ç –≤—ã—à–µ)
	CreatedAt   time.Time `json:"created_at"`  // –ö–æ–≥–¥–∞ –∑–∞–¥–∞—á–∞ –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞
}

// ============================================================
// Storage ‚Äî —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á –≤ –æ–ø–µ—Ä–∞—Ç–∏–≤–Ω–æ–π –ø–∞–º—è—Ç–∏
//
// –°–µ–π—á–∞—Å –¥–∞–Ω–Ω—ã–µ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ map (—Å–ª–æ–≤–∞—Ä—å/—Ö–µ—à-—Ç–∞–±–ª–∏—Ü–∞):
//   –∫–ª—é—á   = ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è Telegram (int64)
//   –∑–Ω–∞—á–µ–Ω–∏–µ = —Å—Ä–µ–∑ (slice) –µ–≥–æ –∑–∞–¥–∞—á
//
// ‚ö†Ô∏è –ü—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ –±–æ—Ç–∞ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ —Ç–µ—Ä—è—é—Ç—Å—è!
// –ü–æ–∑–∂–µ –∑–∞–º–µ–Ω–∏–º –Ω–∞ PostgreSQL
// ============================================================
type Storage struct {
	tasks  map[int64][]Task // –ó–∞–¥–∞—á–∏ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	nextID map[int64]int    // –°—á—ë—Ç—á–∏–∫ ID –∑–∞–¥–∞—á –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	mu     sync.RWMutex     // RWMutex –ø–æ–∑–≤–æ–ª—è–µ—Ç –Ω–µ—Å–∫–æ–ª—å–∫–∏–º –≥–æ—Ä—É—Ç–∏–Ω–∞–º —á–∏—Ç–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
}

// NewStorage —Å–æ–∑–¥–∞—ë—Ç –ø—É—Å—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ
func NewStorage() *Storage {
	return &Storage{
		tasks:  make(map[int64][]Task),
		nextID: make(map[int64]int),
	}
}

// ============================================================
// AddTask –¥–æ–±–∞–≤–ª—è–µ—Ç –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—É—é –∑–∞–¥–∞—á—É
// ============================================================
func (s *Storage) AddTask(userID int64, title, description string) Task {
	s.mu.Lock()         // –ë–ª–æ–∫–∏—Ä—É–µ–º –∑–∞–ø–∏—Å—å (–¥—Ä—É–≥–∏–µ –≥–æ—Ä—É—Ç–∏–Ω—ã –∂–¥—É—Ç)
	defer s.mu.Unlock() // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –ø—Ä–∏ –≤—ã—Ö–æ–¥–µ –∏–∑ —Ñ—É–Ω–∫—Ü–∏–∏

	// –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏ –ø–æ–ª—É—á–∞–µ–º –Ω–æ–≤—ã–π ID
	s.nextID[userID]++
	id := s.nextID[userID]

	task := Task{
		ID:          id,
		Title:       title,
		Description: description,
		Status:      StatusNew,       // –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞ –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç —Å—Ç–∞—Ç—É—Å "–ù–æ–≤–∞—è"
		CreatedAt:   time.Now(),
	}

	// append –¥–æ–±–∞–≤–ª—è–µ—Ç —ç–ª–µ–º–µ–Ω—Ç –≤ –∫–æ–Ω–µ—Ü —Å—Ä–µ–∑–∞
	s.tasks[userID] = append(s.tasks[userID], task)
	return task
}

// ============================================================
// GetTasks –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –≤—Å–µ –∑–∞–¥–∞—á–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// ============================================================
func (s *Storage) GetTasks(userID int64) []Task {
	s.mu.RLock()         // –ë–ª–æ–∫–∏—Ä—É–µ–º —Ç–æ–ª—å–∫–æ —á—Ç–µ–Ω–∏–µ (–¥—Ä—É–≥–∏–µ —á–∏—Ç–∞—Ç–µ–ª–∏ –Ω–µ –∂–¥—É—Ç)
	defer s.mu.RUnlock()

	return s.tasks[userID]
}

// ============================================================
// GetTask –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ–¥–Ω—É –∑–∞–¥–∞—á—É –ø–æ ID
// –í—Ç–æ—Ä–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (bool) –≥–æ–≤–æ—Ä–∏—Ç, –Ω–∞–π–¥–µ–Ω–∞ –ª–∏ –∑–∞–¥–∞—á–∞
// ============================================================
func (s *Storage) GetTask(userID int64, taskID int) (Task, bool) {
	s.mu.RLock()
	defer s.mu.RUnlock()

	for _, task := range s.tasks[userID] {
		if task.ID == taskID {
			return task, true // –ù–∞—à–ª–∏!
		}
	}
	return Task{}, false // –ù–µ –Ω–∞—à–ª–∏
}

// ============================================================
// UpdateStatus –º–µ–Ω—è–µ—Ç —Å—Ç–∞—Ç—É—Å –∑–∞–¥–∞—á–∏
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∞
// ============================================================
func (s *Storage) UpdateStatus(userID int64, taskID int, newStatus string) bool {
	s.mu.Lock()
	defer s.mu.Unlock()

	for i, task := range s.tasks[userID] {
		if task.ID == taskID {
			s.tasks[userID][i].Status = newStatus
			return true
		}
	}
	return false
}

// ============================================================
// DeleteTask —É–¥–∞–ª—è–µ—Ç –∑–∞–¥–∞—á—É –ø–æ ID
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç true, –µ—Å–ª–∏ –∑–∞–¥–∞—á–∞ –Ω–∞–π–¥–µ–Ω–∞ –∏ —É–¥–∞–ª–µ–Ω–∞
// ============================================================
func (s *Storage) DeleteTask(userID int64, taskID int) bool {
	s.mu.Lock()
	defer s.mu.Unlock()

	tasks := s.tasks[userID]
	for i, task := range tasks {
		if task.ID == taskID {
			// –£–¥–∞–ª—è–µ–º —ç–ª–µ–º–µ–Ω—Ç –∏–∑ —Å—Ä–µ–∑–∞:
			// –±–µ—Ä—ë–º –≤—Å—ë –¥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ + –≤—Å—ë –ø–æ—Å–ª–µ —ç–ª–µ–º–µ–Ω—Ç–∞
			s.tasks[userID] = append(tasks[:i], tasks[i+1:]...)
			return true
		}
	}
	return false
}
