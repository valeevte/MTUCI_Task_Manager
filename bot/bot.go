package bot

import (
	"log"
	"sync"

	tgbotapi "github.com/go-telegram-bot-api/telegram-bot-api/v5"
)

// ============================================================
// UserState —Ö—Ä–∞–Ω–∏—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –ù—É–∂–Ω–æ, —á—Ç–æ–±—ã –±–æ—Ç "–ø–æ–º–Ω–∏–ª", –Ω–∞ –∫–∞–∫–æ–º —à–∞–≥–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
// (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤–≤–æ–¥ –Ω–∞–∑–≤–∞–Ω–∏—è –∑–∞–¥–∞—á–∏)
// ============================================================
type UserState struct {
	Step      string // –¢–µ–∫—É—â–∏–π —à–∞–≥ –¥–∏–∞–ª–æ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, "waiting_title")
	TempTitle string // –í—Ä–µ–º–µ–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞–¥–∞—á–∏
}

// ============================================================
// Bot ‚Äî –≥–ª–∞–≤–Ω–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
// –°–æ–¥–µ—Ä–∂–∏—Ç –≤—Å—ë –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞
// ============================================================
type Bot struct {
	api       *tgbotapi.BotAPI     // API-–∫–ª–∏–µ–Ω—Ç –¥–ª—è –æ–±—â–µ–Ω–∏—è —Å Telegram
	storage   *Storage             // –•—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á (–æ–±—â–µ–µ —Å HTTP API)
	users     map[int64]*UserState // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–∏–∞–ª–æ–≥–∞ –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
	mu        sync.Mutex           // –ú—å—é—Ç–µ–∫—Å ‚Äî –∑–∞—â–∏—â–∞–µ—Ç users –æ—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∏–∑ –≥–æ—Ä—É—Ç–∏–Ω
	webAppURL string               // URL Mini App (–¥–ª—è –∫–Ω–æ–ø–∫–∏ –≤ –∫–ª–∞–≤–∏–∞—Ç—É—Ä–µ)
}

// ============================================================
// New —Å–æ–∑–¥–∞—ë—Ç –Ω–æ–≤–æ–≥–æ –±–æ—Ç–∞
// token     ‚Äî —Ç–æ–∫–µ–Ω, –ø–æ–ª—É—á–µ–Ω–Ω—ã–π —É @BotFather –≤ Telegram
// storage   ‚Äî –æ–±—â–µ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –∑–∞–¥–∞—á (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –±–æ—Ç–æ–º, –∏ HTTP API)
// webAppURL ‚Äî URL Mini App (–¥–ª—è –∫–Ω–æ–ø–∫–∏ ¬´–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ¬ª)
// ============================================================
func New(token string, storage *Storage, webAppURL string) (*Bot, error) {
	// –°–æ–∑–¥–∞—ë–º API-–∫–ª–∏–µ–Ω—Ç
	api, err := tgbotapi.NewBotAPI(token)
	if err != nil {
		return nil, err
	}

	// Debug = true –ø–æ–∫–∞–∂–µ—Ç –≤ –∫–æ–Ω—Å–æ–ª–∏ –≤—Å–µ –∑–∞–ø—Ä–æ—Å—ã/–æ—Ç–≤–µ—Ç—ã (–ø–æ–ª–µ–∑–Ω–æ –¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
	// –ò–∑–º–µ–Ω–∏ –Ω–∞ true, –µ—Å–ª–∏ —Ö–æ—á–µ—à—å –≤–∏–¥–µ—Ç—å –ø–æ–¥—Ä–æ–±–Ω—ã–µ –ª–æ–≥–∏
	api.Debug = false

	log.Printf("ü§ñ –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω –∫–∞–∫ @%s", api.Self.UserName)

	return &Bot{
		api:       api,
		storage:   storage,
		users:     make(map[int64]*UserState),
		webAppURL: webAppURL,
	}, nil
}

// ============================================================
// Start –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç Long Polling ‚Äî –±–æ—Ç "—Å–ª—É—à–∞–µ—Ç" Telegram –∏ –ø–æ–ª—É—á–∞–µ—Ç –Ω–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
// ============================================================
func (b *Bot) Start() {
	// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π
	config := tgbotapi.NewUpdate(0)
	config.Timeout = 30 // –ñ–¥—ë–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ 30 —Å–µ–∫—É–Ω–¥ (long polling)

	// GetUpdatesChan –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç Go-–∫–∞–Ω–∞–ª (channel), –∫—É–¥–∞ –ø—Ä–∏—Ö–æ–¥—è—Ç –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
	updates := b.api.GetUpdatesChan(config)

	// –ß–∏—Ç–∞–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∑ –∫–∞–Ω–∞–ª–∞ –≤ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–º —Ü–∏–∫–ª–µ
	for update := range updates {
		// ‚ö° –ö–∞–∂–¥–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ (goroutine)
		// –≠—Ç–æ –ø–æ–∑–≤–æ–ª—è–µ—Ç –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å–æ–æ–±—â–µ–Ω–∏–π –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
		go b.handleUpdate(update)
	}
}

// ============================================================
// handleUpdate –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Ç–∏–ø –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –µ–≥–æ
// –∫ –Ω—É–∂–Ω–æ–º—É –æ–±—Ä–∞–±–æ—Ç—á–∏–∫—É (handler)
// ============================================================
func (b *Bot) handleUpdate(update tgbotapi.Update) {
	// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —Ä–∞–∑–Ω–æ–≥–æ —Ç–∏–ø–∞:

	// 1. Callback ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª inline-–∫–Ω–æ–ø–∫—É
	if update.CallbackQuery != nil {
		b.handleCallback(update.CallbackQuery)
		return
	}

	// 2. Message ‚Äî –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –æ—Ç–ø—Ä–∞–≤–∏–ª —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
	if update.Message != nil {
		b.handleMessage(update.Message)
		return
	}

	// –î—Ä—É–≥–∏–µ —Ç–∏–ø—ã –æ–±–Ω–æ–≤–ª–µ–Ω–∏–π (—Ñ–æ—Ç–æ, —Å—Ç–∏–∫–µ—Ä—ã –∏ —Ç.–¥.) –ø–æ–∫–∞ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º
}

// ============================================================
// –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
// –ú—å—é—Ç–µ–∫—Å (mu) –Ω—É–∂–µ–Ω, –ø–æ—Ç–æ–º—É —á—Ç–æ –≥–æ—Ä—É—Ç–∏–Ω—ã —Ä–∞–±–æ—Ç–∞—é—Ç –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ
// –∏ –º–æ–≥—É—Ç –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —á–∏—Ç–∞—Ç—å/–ø–∏—Å–∞—Ç—å –≤ map ‚Äî —ç—Ç–æ –≤—ã–∑–æ–≤–µ—Ç –æ—à–∏–±–∫—É
// ============================================================

// getUserState –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
func (b *Bot) getUserState(userID int64) *UserState {
	b.mu.Lock()
	defer b.mu.Unlock()

	state, exists := b.users[userID]
	if !exists {
		// –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–æ–≤—ã–π ‚Äî —Å–æ–∑–¥–∞—ë–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
		state = &UserState{}
		b.users[userID] = state
	}
	return state
}

// resetUserState —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –Ω–∞—á–∞–ª—å–Ω–æ–µ
func (b *Bot) resetUserState(userID int64) {
	b.mu.Lock()
	defer b.mu.Unlock()

	b.users[userID] = &UserState{}
}
