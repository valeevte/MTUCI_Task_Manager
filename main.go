package main

import (
	"log"
	"net/http"
	"os"

	"mtuci-task-manager/api"
	"mtuci-task-manager/bot"

	"github.com/joho/godotenv"
)

func main() {
	// ============================================================
	// –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
	// ============================================================
	if err := godotenv.Load(); err != nil {
		log.Println("‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–∏—Å—Ç–µ–º–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è")
	}

	// –¢–æ–∫–µ–Ω –±–æ—Ç–∞ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
	token := os.Getenv("TELEGRAM_BOT_TOKEN")
	if token == "" {
		log.Fatal("‚ùå TELEGRAM_BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω! –£–∫–∞–∂–∏ –µ–≥–æ –≤ —Ñ–∞–π–ª–µ .env")
	}

	// URL Mini App (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –¥–ª—è —Ä–∞–±–æ—Ç—ã –±–æ—Ç–∞, –Ω–æ –Ω—É–∂–µ–Ω –¥–ª—è –∫–Ω–æ–ø–∫–∏)
	webAppURL := os.Getenv("WEBAPP_URL")
	if webAppURL == "" {
		log.Println("‚ö†Ô∏è  WEBAPP_URL –Ω–µ –∑–∞–¥–∞–Ω ‚Äî –∫–Ω–æ–ø–∫–∞ ¬´–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ¬ª –Ω–µ –ø–æ—è–≤–∏—Ç—Å—è –≤ –±–æ—Ç–µ")
	} else {
		log.Printf("üåê Mini App URL: %s", webAppURL)
	}

	// –ü–æ—Ä—Ç HTTP-—Å–µ—Ä–≤–µ—Ä–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 8080)
	port := os.Getenv("SERVER_PORT")
	if port == "" {
		port = "8080"
	}

	// ============================================================
	// –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—â–µ–≥–æ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∑–∞–¥–∞—á
	// –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∏ –±–æ—Ç–æ–º, –∏ HTTP API
	// ============================================================
	storage := bot.NewStorage()

	// ============================================================
	// –°–æ–∑–¥–∞–Ω–∏–µ –±–æ—Ç–∞
	// ============================================================
	b, err := bot.New(token, storage, webAppURL)
	if err != nil {
		log.Fatalf("‚ùå –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –±–æ—Ç–∞: %v", err)
	}

	// ============================================================
	// –ó–∞–ø—É—Å–∫ HTTP-—Å–µ—Ä–≤–µ—Ä–∞ (–≤ –æ—Ç–¥–µ–ª—å–Ω–æ–π –≥–æ—Ä—É—Ç–∏–Ω–µ)
	// –û–±—Å–ª—É–∂–∏–≤–∞–µ—Ç:
	//   - /api/*     ‚Äî REST API –¥–ª—è Mini App
	//   - /*         ‚Äî —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–µ —Ñ–∞–π–ª—ã —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–∞ (–ø–∞–ø–∫–∞ web/)
	// ============================================================
	apiServer := api.NewServer(storage, token)
	go func() {
		router := apiServer.Router()
		log.Printf("üåê HTTP-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω –Ω–∞ http://localhost:%s", port)
		if err := http.ListenAndServe(":"+port, router); err != nil {
			log.Fatalf("‚ùå –û—à–∏–±–∫–∞ HTTP-—Å–µ—Ä–≤–µ—Ä–∞: %v", err)
		}
	}()

	// ============================================================
	// –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ (–≤ –æ—Å–Ω–æ–≤–Ω–æ–º –ø–æ—Ç–æ–∫–µ)
	// Start() –∑–∞–ø—É—Å–∫–∞–µ—Ç –±–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π —Ü–∏–∫–ª –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π
	// ============================================================
	log.Println("‚úÖ –ë–æ—Ç –∏ HTTP-—Å–µ—Ä–≤–µ—Ä –∑–∞–ø—É—â–µ–Ω—ã! –ù–∞–∂–º–∏ Ctrl+C –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏.")
	b.Start()
}
